name: Release

on:
  workflow_run:
    workflows: [Build]
    types: [completed]

permissions:
  contents: write
  id-token: write  # Required for PyPI trusted publishing

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    environment:
      name: pypi
      url: https://pypi.org/p/artefactual
    env:
      TAG_NAME: ${{ github.event.workflow_run.head_branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b  # v7.2.0
        with:
          enable-cache: true

      - name: Generate changelog
        id: changelog
        run: |
          uvx git-cliff --latest --tag "$TAG_NAME" -o RELEASE_NOTES.md
          {
            echo 'notes<<EOF'
            cat RELEASE_NOTES.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2.5.0
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.TAG_NAME }}
          body: ${{ steps.changelog.outputs.notes }}
          files: dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@106e0b0b7c337fa67ed433972f777c6357f78598  # v1.13.0
        with:
          print-hash: true

      - run: rm -f RELEASE_NOTES.md
